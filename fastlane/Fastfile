default_platform(:ios)

platform :ios do
  # Get the latest build number from TestFlight
  def bump_build_number()
    latest_build_number = latest_testflight_build_number(initial_build_number: 0)
    return (latest_build_number + 1)
  end
  
  desc "Push a new beta build to TestFlight"
  lane :beta do
    
    puts "Building beta version"
    
    app_store_connect_api_key(
     key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
     issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
     key_content: ENV["APP_STORE_CONNECT_KEY"],
     is_key_content_base64: false,
     in_house: false # detecting this via ASC private key not currently supported
   )
    
    # Bump the build number
    build_number = bump_build_number()
    puts "Bumping build number to #{build_number}"

    # Build the app with the updated build number
    build_app(
      scheme: "I am Groot",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "io.appnap.iamgroot" => "Sarwar Apple Distribution - I am Groot"
        }
      }
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      api_key: {
        key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
        key: ENV["APP_STORE_CONNECT_KEY"]
      }
    )
  end
end
